"use strict";function t(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function e(t){var e;return e=t.detail.y,e-t.currentTarget.offsetTop<150&&(e=t.currentTarget.offsetTop),e<30&&(e+=70),e-30}Component({data:{ctrl:{}},properties:{childs:Array,opts:Array},attached:function(){this.triggerEvent("add",this,{bubbles:!0,composed:!0})},detached:function(){this.root&&this.root._edit==this&&(this.root._edit=void 0)},methods:{editStart:function(e){var i=this;if(this.data.opts[4]){var r=e.currentTarget.dataset.i;this.data.ctrl["e"+r]?(this.root._mask.pop(),this.root._maskTap(),this.setData(t({},"ctrl.e"+r,2)),setTimeout(function(){i.setData(t({},"ctrl.e"+r,3))},50)):(this.setData(t({},"ctrl.e"+r,1)),setTimeout(function(){i.root._mask.push(function(){i.setData(t({},"ctrl.e"+r,0))})},50),this.root._edit=this,this.i=r,this.cursor=this.getNode(r).text.length)}},editInput:function(t){var e=t.target.dataset.i,i=t.detail.value.replace(/ {2,}/,function(t){for(var e=" ",i=1;i<t.length;i++)e+=" ";return e});this.root._editVal("nodes["+(this.data.opts[6]+e).replace(/_/g,"].children[")+"].text",this.getNode(e).text,i),this.cursor=t.detail.cursor},editEnd:function(e){var i=e.target.dataset.i;this.root.setData(t({},"nodes["+(this.data.opts[6]+i).replace(/_/g,"].children[")+"].text",e.detail.value)),this.setData(t({},"ctrl.e"+i,0))},insert:function(t){var e=this;setTimeout(function(){var i=e.i.split("_"),r=parseInt(i.pop()),s=i.join("_"),o=s?e.getNode(s).children:e.data.childs,a=o.slice(0);if(a[r])if(a[r].text){var n=a[r].text,c=[];e.cursor&&c.push({type:"text",text:n.substring(0,e.cursor)}),c.push(t),e.cursor<n.length&&c.push({type:"text",text:n.substring(e.cursor)}),a.splice.apply(a,[r,1].concat(c))}else a.splice(r+1,0,t);else a.push(t);s=e.data.opts[6]+s,"_"==s[s.length-1]&&(s=s.slice(0,-1)),e.root._editVal("nodes"+(s?"["+s.replace(/_/g,"].children[")+"].children":""),o,a,!0)},200)},remove:function(t){var e=t.split("_"),i=e.pop(),r=e.join("_"),s=r?this.getNode(r).children:this.data.childs,o=s.slice(0);o.splice(i,1),this.root._edit=void 0,this.root._maskTap(),r=this.data.opts[6]+r,"_"==r[r.length-1]&&(r=r.slice(0,-1)),this.root._editVal("nodes"+(r?"["+r.replace(/_/g,"].children[")+"].children":""),s,o,!0)},nodeTap:function(i){var r=this;if(this.data.opts[4]){if(this.root._lock)return;this.root._lock=!0,setTimeout(function(){r.root._lock=!1},50);var s=i.currentTarget.dataset.i,o=this.getNode(s);if(3==this.data.ctrl["e"+this.i])return;if(this.root._maskTap(),this.setData(t({},"ctrl.e"+s,1)),this.root._mask.push(function(){r.setData(t({},"ctrl.e"+s,0))}),this.root._edit=this,1==o.children.length&&"text"==o.children[0].type){var a=s+"_0";this.data.ctrl["e"+a]||(this.setData(t({},"ctrl.e"+a,1)),this.root._mask.push(function(){r.setData(t({},"ctrl.e"+a,0))}),this.cursor=o.children[0].text.length),this.i=a}else(this.i||"").includes(s)||(this.i=s+"_");var n=this.root._getItem(o);this.root._tooltip({top:e(i),items:n,success:function(t){if("大小"==n[t]){var a=o.attrs.style||"",c=a.match(/;font-size:([0-9]+)px/);c=c?parseInt(c[1]):16,r.root._slider({min:10,max:30,value:c,top:e(i),changing:function(t){Math.abs(t-c)>2&&(r.changeStyle("font-size",s,t+"px",c+"px"),c=i.detail.value)},change:function(t){t!=c&&r.changeStyle("font-size",s,t+"px",c+"px"),r.root._editVal("nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.style",a,r.getNode(s).attrs.style)}})}else if("删除"==n[t])r.remove(s);else{var h,l,p=o.attrs.style||"",d="",u=n[t];"斜体"==u?(h="font-style",l="italic"):"粗体"==u?(h="font-weight",l="bold"):"下划线"==u?(h="text-decoration",l="underline"):"居中"==u?(h="text-align",l="center"):"缩进"==u&&(h="text-indent",l="2em"),d=p.includes(h+":")?p.replace(new RegExp(h+":[^;]+"),""):p+";"+h+":"+l,r.root._editVal("nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.style",p,d,!0)}}})}},mediaTap:function(e){var i=this;if(this.data.opts[4]){var r=e.target.dataset.i,s=this.getNode(r),o=this.root._getItem(s);this.root._edit=this,this.i=r,this.root._tooltip({top:e.target.offsetTop-30,items:o,success:function(e){"封面"==o[e]?i.root.getSrc("img",s.attrs.poster).then(function(t){i.root._editVal("nodes["+(i.data.opts[6]+r).replace(/_/g,"].children[")+"].attrs.poster",s.attrs.poster,t,!0)}).catch(function(){}):"删除"==o[e]?i.remove(r):(i.root.setData(t({},"nodes["+(i.data.opts[6]+r).replace(/_/g,"].children[")+"].attrs.loop",!s.attrs.loop)),wx.showToast({title:"成功"}))}}),this.root._lock=!0,setTimeout(function(){i.root._lock=!1},50)}},changeStyle:function(e,i,r,s){var o=this.getNode(i).attrs.style||"";o.includes(";"+e+":"+s)?o=o.replace(";"+e+":"+s,";"+e+":"+r):o+=";"+e+":"+r,this.root.setData(t({},"nodes["+(this.data.opts[6]+i).replace(/_/g,"].children[")+"].attrs.style",o))},noop:function(){},getNode:function(t){for(var e=t.split("_"),i=this.data.childs[e[0]],r=1;r<e.length;r++)i=i.children[e[r]];return i},play:function(t){if(this.root.data.pauseVideo){for(var e=!1,i=t.target.id,r=this.root._videos.length;r--;)this.root._videos[r].id==i?e=!0:this.root._videos[r].pause();if(!e){var s=wx.createVideoContext(i,this);s.id=i,this.root._videos.push(s)}}},imgTap:function(i){var r=this;if(this.data.opts[4]){var s=i.target.dataset.i,o=this.getNode(s),a=this.root._getItem(o);this.root._edit=this,this.i=s,this.root._maskTap(),this.setData(t({},"ctrl.e"+s,1)),this.root._mask.push(function(){r.setData(t({},"ctrl.e"+s,0))}),this.root._tooltip({top:e(i),items:a,success:function(n){if("换图"==a[n])r.root.getSrc("img",o.attrs.src).then(function(t){r.root._editVal("nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.src",o.attrs.src,t,!0)}).catch(function(){});else if("宽度"==a[n]){var c=o.attrs.style||"",h=c.match(/max-width:([0-9]+)%/);h=h?parseInt(h[1]):100,r.root._slider({min:0,max:100,value:h,top:e(i),changing:function(t){Math.abs(t-h)>5&&(r.changeStyle("max-width",s,t+"%",h+"%"),h=t)},change:function(t){t!=h&&(r.changeStyle("max-width",s,t+"%",h+"%"),h=t),r.root._editVal("nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.style",c,r.getNode(s).attrs.style)}})}else"超链接"==a[n]?r.root.getSrc("link").then(function(t){r.root._editVal("nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"]",o,{name:"a",attrs:{href:t},children:[o]},!0),wx.showToast({title:"成功"})}).catch(function(){}):"预览图"==a[n]?r.root.getSrc("img",o.attrs["original-src"]).then(function(t){r.root._editVal("nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.original-src",o.attrs["original-src"],t,!0),wx.showToast({title:"成功"})}).catch(function(){}):"删除"==a[n]?r.remove(s):(r.root.setData(t({},"nodes["+(r.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.ignore",!o.attrs.ignore)),wx.showToast({title:"成功"}))}}),this.root._lock=!0,setTimeout(function(){r.root._lock=!1},50)}else{var o=this.getNode(i.target.dataset.i);if(o.a)return this.linkTap(o.a);if(o.attrs.ignore)return;if(this.root.triggerEvent("imgtap",o.attrs),this.root.data.previewImg){var n=this.root.imgList[o.i];wx.previewImage({current:n,urls:this.root.imgList})}}},imgLoad:function(e){var i=this;this.data.opts[4]&&setTimeout(function(){var e=i.getNode(s).attrs.id||"n"+s;wx.createSelectorQuery().in(i).select("#"+e).boundingClientRect().exec(function(e){i.setData(t({},"ctrl.h"+s,e[0].height))})},50);var r,s=e.target.dataset.i,o=this.getNode(s);if(o.w)(this.data.opts[1]&&!this.data.ctrl[s]||-1==this.data.ctrl[s])&&(r=1);else if(r=e.detail.width,this.data.opts[4]){var a={},n="nodes["+(this.data.opts[6]+s).replace(/_/g,"].children[")+"].attrs.";r<150&&(a[n+"ignore"]="T"),a[n+"width"]=r.toString(),this.root.setData(a)}r&&this.setData(t({},"ctrl."+s,r))},linkTap:function(t){var i=this;if(this.data.opts[4]){var r=t.currentTarget.dataset.i,s=this.getNode(r),o=this.root._getItem(s);this.root._tooltip({top:e(t),items:o,success:function(t){"更换链接"==o[t]?i.root.getSrc("link",s.attrs.href).then(function(t){i.root._editVal("nodes["+(i.data.opts[6]+r).replace(/_/g,"].children[")+"].attrs.href",s.attrs.href,t,!0),wx.showToast({title:"成功"})}).catch(function(){}):i.remove(r)}})}else{var s=t.currentTarget?this.getNode(t.currentTarget.dataset.i):{},a=s.attrs||t,n=a.href;this.root.triggerEvent("linktap",Object.assign({innerText:this.root.getText(s.children||[])},a)),n&&("#"==n[0]?this.root.navigateTo(n.substring(1)).catch(function(){}):n.includes("://")?this.root.data.copyLink&&wx.setClipboardData({data:n,success:function(){return wx.showToast({title:"链接已复制"})}}):wx.navigateTo({url:n,fail:function(){wx.switchTab({url:n,fail:function(){}})}}))}},mediaError:function(e){var i=e.target.dataset.i,r=this.getNode(i);if("video"==r.name||"audio"==r.name){var s=(this.data.ctrl[i]||0)+1;if(s>r.src.length&&(s=0),s<r.src.length)return this.setData(t({},"ctrl."+i,s))}else"img"==r.name&&this.data.opts[2]&&this.setData(t({},"ctrl."+i,-1));this.root&&this.root.triggerEvent("error",{source:r.name,attrs:r.attrs,errMsg:e.detail.errMsg})}}});